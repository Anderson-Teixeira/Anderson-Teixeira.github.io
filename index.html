<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Adium Salesforce</title>
    <style type="text/css">
        /* Esconder botão original do Salesforce */
        .embeddedServiceHelpButton {
            display: none !important;
            visibility: hidden !important;
        }
        
        .botao-chat-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px; /* Espaço entre o balão e o botão */
        }

        /* Estilo do balão de mensagem */
        .chat-balloon {
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #333;
            position: relative;
            margin-right: 10px;
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Triângulo do balão */
        .chat-balloon::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 10px solid #fff;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* Animação de entrada */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .botao-chat {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to right, #ff0000, #e60000);
            width: 55px;
            height: 55px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(255, 0, 0, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .botao-chat:hover {
            background: linear-gradient(to right, #e60000, #cc0000);
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            transform: scale(1.1);
        }
        
        .botao-chat:disabled {
            background: #ffcccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            display: none;
        }
        
        .chat-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            padding: 10px;
        }

        /* Classe para esconder o balão quando o chat estiver aberto */
        .hidden {
            display: none !important;
        }
        
        /* Indicador de carregamento */
        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .botao-chat.loading .loading-indicator {
            display: block;
        }

        .botao-chat.loading .chat-img {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="botao-chat-container">
        <div id="chatBalloon" class="chat-balloon">Como posso ajudar?</div>
        <button id="botaoChat" class="botao-chat" onclick="ChatApp.iniciar()">
            <div class="loading-indicator"></div>
            <img src="images/Adium Logo vermelho.png" alt="Logo Adium" class="chat-img"/>
        </button>
    </div>

    <script type="text/javascript">
        // Namespace para a aplicação de chat
        const ChatApp = (function() {
            // Configurações
            const config = {
                scriptUrl: 'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405/assets/js/bootstrap.min.js',
                orgId: '00DVA000001eH3B',
                componentName: 'ChatAdium_GitHubPages',
                deploymentUrl: 'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405',
                scrtUrl: 'https://adiumbr--devchatbot.sandbox.my.salesforce-scrt.com',
                maxTentativas: 8,
                intervaloTentativa: 2500,
                tempoInicializacao: 3000
            };
            
            // Estado
            let estado = {
                tentativas: 0,
                carregando: false,
                inicializado: false,
                scriptCarregado: false
            };
            
            // Cache de elementos DOM
            let dom = {
                botao: null,
                balao: null
            };
            
            // Helpers
            function log(mensagem, tipo = 'info', dados = null) {
                const tipos = {
                    info: console.log,
                    erro: console.error,
                    aviso: console.warn
                };
                
                if (dados) {
                    tipos[tipo](`[Chat Adium] ${mensagem}`, dados);
                } else {
                    tipos[tipo](`[Chat Adium] ${mensagem}`);
                }
            }
            
            // Função para mostrar estado de carregamento
            function setCarregando(estado) {
                dom.botao.classList[estado ? 'add' : 'remove']('loading');
                dom.botao.disabled = estado;
                if (estado) {
                    dom.balao.classList.add('hidden');
                }
                ChatApp.estado.carregando = estado;
            }
            
            // Verifica se a API do Salesforce está disponível e pronta
            function verificarAPIDisponivel() {
                try {
                    const bootstrap = window.embeddedservice_bootstrap;
                    
                    // Debug
                    log('Verificando disponibilidade da API Salesforce', 'info', {
                        bootstrapExiste: typeof bootstrap !== 'undefined',
                        utilAPI: bootstrap && bootstrap.utilAPI,
                        launchChat: bootstrap && bootstrap.utilAPI && typeof bootstrap.utilAPI.launchChat === 'function'
                    });
                    
                    return typeof bootstrap !== 'undefined' &&
                           bootstrap.utilAPI &&
                           typeof bootstrap.utilAPI.launchChat === 'function';
                } catch (e) {
                    log('Erro ao verificar disponibilidade da API', 'erro', e);
                    return false;
                }
            }
            
            // Inicializa o chat 
            function iniciar() {
                if (ChatApp.estado.carregando) return;
                
                setCarregando(true);
                log('Iniciando chat...');
                
                // Verificar se a API está disponível
                if (verificarAPIDisponivel()) {
                    log('API disponível, lançando chat');
                    
                    // API disponível, lança o chat
                    window.embeddedservice_bootstrap.utilAPI.launchChat()
                        .then(() => {
                            log('Chat lançado com sucesso');
                            ChatApp.estado.inicializado = true;
                            setCarregando(false);
                        })
                        .catch((erro) => {
                            log('Erro ao lançar chat', 'erro', erro);
                            setCarregando(false);
                            dom.balao.classList.remove('hidden');
                            alert('Não foi possível iniciar o chat. Tente novamente mais tarde.');
                        });
                } else {
                    // API não disponível
                    log(`API não disponível. Tentativa ${ChatApp.estado.tentativas + 1} de ${config.maxTentativas}`);
                    
                    if (ChatApp.estado.tentativas < config.maxTentativas) {
                        ChatApp.estado.tentativas++;
                        
                        // Se é a primeira tentativa ou se o script não está marcado como carregado,
                        // tenta carregar o script novamente
                        if (!ChatApp.estado.scriptCarregado) {
                            log('Tentando carregar o script novamente');
                            carregarScript();
                        }
                        
                        // Tenta novamente após intervalo
                        log(`Agendando nova tentativa em ${config.intervaloTentativa}ms`);
                        setTimeout(iniciar, config.intervaloTentativa);
                    } else {
                        // Esgotou tentativas, reinicia o processo
                        log('Esgotadas as tentativas. Reiniciando processo.', 'aviso');
                        ChatApp.estado.tentativas = 0;
                        ChatApp.estado.scriptCarregado = false;
                        setCarregando(false);
                        
                        // Remove scripts antigos
                        const scriptAntigo = document.getElementById('bootstrap-script');
                        if (scriptAntigo) {
                            scriptAntigo.remove();
                        }
                        
                        // Limpa qualquer resíduo do Salesforce
                        limparResiduosSalesforce();
                        
                        // Tenta carregar novamente após intervalo
                        setTimeout(() => {
                            carregarScript();
                            alert('O serviço de chat não está respondendo. Recarregando componentes...');
                        }, 500);
                    }
                }
            }
            
            // Limpa resíduos da API do Salesforce para evitar problemas de inicialização
            function limparResiduosSalesforce() {
                try {
                    // Limpa referência para evitar conflitos
                    window.embeddedservice_bootstrap = undefined;
                    
                    // Remove quaisquer elementos residuais do Salesforce
                    const elementos = document.querySelectorAll('.embeddedServiceHelpButton, .embeddedServiceSidebar, .embeddedServiceSidebarState');
                    elementos.forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    
                    log('Resíduos do Salesforce removidos');
                } catch (e) {
                    log('Erro ao limpar resíduos do Salesforce', 'erro', e);
                }
            }
            
            // Carrega o script do Salesforce ESW
            function carregarScript() {
                log('Carregando script do Salesforce');
                
                // Remove script existente se houver
                const scriptExistente = document.getElementById('bootstrap-script');
                if (scriptExistente) {
                    scriptExistente.remove();
                    log('Script existente removido');
                }
                
                // Cria o novo script
                const script = document.createElement('script');
                script.id = 'bootstrap-script';
                script.type = 'text/javascript';
                script.src = config.scriptUrl;
                
                // Eventos do script
                script.onload = function() {
                    log('Script carregado com sucesso');
                    ChatApp.estado.scriptCarregado = true;
                    
                    // Aguarda tempo adicional para garantir que o script inicialize corretamente
                    setTimeout(configurarChat, config.tempoInicializacao);
                };
                
                script.onerror = function(erro) {
                    log('Erro ao carregar script', 'erro', erro);
                    ChatApp.estado.scriptCarregado = false;
                    setCarregando(false);
                    alert('Não foi possível carregar o serviço de chat. Verifique sua conexão de internet.');
                };
                
                // Adiciona o script na página
                document.head.appendChild(script);
                log('Script adicionado ao documento');
            }
            
            // Configura o chat do Salesforce
            function configurarChat() {
                log('Configurando chat');
                
                try {
                    if (typeof window.embeddedservice_bootstrap === 'undefined') {
                        log('Bootstrap ainda não está definido, tentando novamente em 2s', 'aviso');
                        setTimeout(configurarChat, 2000);
                        return;
                    }
                    
                    const bootstrap = window.embeddedservice_bootstrap;
                    const settings = bootstrap.settings;
                    
                    log('Aplicando configurações');
                    
                    // Configurações básicas
                    settings.language = 'pt_BR';
                    settings.displayHelpButton = false;
                    settings.chatButtonPosition = "-30px,-200px";
                    
                    // Configuração de avatares e logos
                    settings.avatarImgURL = "images/Adium Logo vermelho.png";
                    settings.chatbotAvatarImgURL = "images/Adium Logo vermelho.png";
                    settings.smallCompanyLogoImgURL = "images/Adium Logo vermelho.png";
                    
                    // Configurações adicionais
                    settings.storageDomain = window.location.hostname;
                    settings.loadingText = "Conectando...";
                    settings.defaultMinimizedText = "Fale com a Adium";
                    
                    // Dimensões da janela de chat
                    settings.widgetWidth = "320px";
                    settings.widgetHeight = "500px";
                    settings.widgetFontSize = "16px";
                    
                    log('Inicializando componente do Salesforce');
                    
                    // Inicializa o chat
                    bootstrap.init(
                        config.orgId,
                        config.componentName,
                        config.deploymentUrl,
                        {
                            scrt2URL: config.scrtUrl
                        }
                    );
                    
                    // Adiciona eventos
                    if (bootstrap.utilAPI) {
                        bootstrap.utilAPI.addEventHandler('afterInit', function() {
                            log('Chat inicializado com sucesso (evento afterInit)');
                            ChatApp.estado.inicializado = true;
                            setCarregando(false);
                        });
                        
                        bootstrap.utilAPI.addEventHandler('afterDestroy', function() {
                            log('Chat encerrado');
                            ChatApp.estado.inicializado = false;
                            dom.balao.classList.remove('hidden');
                        });
                    }
                    
                    log('Configuração concluída');
                } catch (err) {
                    log('Erro ao configurar chat', 'erro', err);
                    setCarregando(false);
                    alert('Erro ao inicializar o chat. Recarregue a página e tente novamente.');
                }
            }
            
            // Inicializa a aplicação
            function inicializar() {
                log('Inicializando aplicação');
                
                // Cache de elementos DOM
                dom.botao = document.getElementById('botaoChat');
                dom.balao = document.getElementById('chatBalloon');
                
                // Carregar script automaticamente
                setTimeout(carregarScript, 1000);
                
                // Configurar interações do balão
                dom.botao.addEventListener('mouseenter', function() {
                    if (!ChatApp.estado.carregando && !ChatApp.estado.inicializado) {
                        dom.balao.classList.remove('hidden');
                    }
                });
                
                dom.botao.addEventListener('mouseleave', function() {
                    setTimeout(function() {
                        dom.balao.classList.add('hidden');
                    }, 2000);
                });
                
                // Esconder balão após 5 segundos
                setTimeout(function() {
                    dom.balao.classList.add('hidden');
                }, 5000);
                
                // Detecta erros de script do Salesforce
                window.addEventListener('error', function(e) {
                    if (e.filename && e.filename.includes('bootstrap.min.js')) {
                        log('Erro detectado no script do Salesforce', 'erro', e);
                        setCarregando(false);
                    }
                });
                
                log('Aplicação inicializada');
            }
            
            // Inicializa quando a página carregar
            window.addEventListener('load', inicializar);
            
            // Interface pública
            return {
                estado,
                iniciar,
                carregar: carregarScript,
                verificarAPI: verificarAPIDisponivel
            };
        })();
    </script>
</body>
</html>
