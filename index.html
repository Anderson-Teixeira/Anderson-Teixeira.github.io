<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Adium</title>
  <style>
    .embeddedServiceHelpButton { display: none !important; }
    
    .chat-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chat-balloon {
      background: #fff;
      padding: 12px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      font-size: 14px;
      margin-right: 10px;
      border: 1px solid #e0e0e0;
      animation: fadeIn 0.3s;
      position: relative;
    }
    
    .chat-balloon::after {
      content: '';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      border-left: 10px solid #fff;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }
    
    .btn-chat {
      position: relative;
      width: 55px;
      height: 55px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      background: linear-gradient(to right, #ff0000, #e60000);
      box-shadow: 0 2px 12px rgba(255,0,0,0.2);
      transition: all 0.3s;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-chat:hover {
      background: linear-gradient(to right, #e60000, #cc0000);
      box-shadow: 0 4px 15px rgba(255,0,0,0.3);
      transform: scale(1.1);
    }
    
    .btn-chat:disabled {
      background: #ffcccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .logo-img {
      width: 55%;
      height: auto;
    }
    
    .loader {
      display: none;
      position: absolute;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .btn-chat.loading .loader { display: block; }
    .btn-chat.loading .logo-img { opacity: 0.5; }
    .hidden { display: none !important; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="chatBalloon" class="chat-balloon">Como posso ajudar?</div>
    <button id="chatBtn" class="btn-chat" onclick="ChatApp.start()">
      <div class="loader"></div>
      <img src="images/Adium Logo vermelho.png" alt="Logo Adium" class="logo-img">
    </button>
  </div>

  <script>
    // Namespace para aplicação de chat
    const ChatApp = (() => {
      // Configurações e estado
      const config = {
        script: 'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405/assets/js/bootstrap.min.js',
        orgId: '00DVA000001eH3B',
        componentName: 'ChatAdium_GitHubPages',
        deploymentUrl: 'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405',
        scrtUrl: 'https://adiumbr--devchatbot.sandbox.my.salesforce-scrt.com',
        maxRetries: 5,
        retryDelay: 2000
      };
      
      let state = {
        retries: 0,
        loading: false
      };
      
      // Elementos DOM
      const elements = {
        btn: null,
        balloon: null
      };
      
      // Inicialização
      const init = () => {
        elements.btn = document.getElementById('chatBtn');
        elements.balloon = document.getElementById('chatBalloon');
        
        // Carregar script do chat
        setTimeout(loadScript, 1000);
        
        // Configurar interações do balão
        elements.btn.addEventListener('mouseenter', () => {
          if (!state.loading) elements.balloon.classList.remove('hidden');
        });
        
        elements.btn.addEventListener('mouseleave', () => {
          setTimeout(() => elements.balloon.classList.add('hidden'), 2000);
        });
        
        setTimeout(() => elements.balloon.classList.add('hidden'), 5000);
      };
      
      // Atualiza UI com estado de carregamento
      const setLoading = (isLoading) => {
        state.loading = isLoading;
        
        if (isLoading) {
          elements.btn.classList.add('loading');
          elements.btn.disabled = true;
          elements.balloon.classList.add('hidden');
        } else {
          elements.btn.classList.remove('loading');
          elements.btn.disabled = false;
        }
      };
      
      // Carrega o script do Salesforce
      const loadScript = () => {
        document.getElementById('bootstrap-script')?.remove();
        
        const script = document.createElement('script');
        script.id = 'bootstrap-script';
        script.src = config.script;
        script.onload = () => setTimeout(setupChat, 1500);
        script.onerror = () => {
          setLoading(false);
          alert('Não foi possível carregar o serviço de chat. Verifique sua conexão.');
        };
        
        document.head.appendChild(script);
      };
      
      // Configura o chat do Salesforce
      const setupChat = () => {
        try {
          if (typeof embeddedservice_bootstrap === 'undefined') {
            setTimeout(setupChat, 2000);
            return;
          }
          
          // Configurações do chat
          const settings = embeddedservice_bootstrap.settings;
          
          // Básicas
          settings.language = 'pt_BR';
          settings.displayHelpButton = false;
          settings.chatButtonPosition = "-30px,-200px";
          
          // Visuais
          settings.avatarImgURL = "images/Adium Logo vermelho.png";
          settings.chatbotAvatarImgURL = "images/Adium Logo vermelho.png";
          settings.smallCompanyLogoImgURL = "images/Adium Logo vermelho.png";
          settings.loadingText = "Conectando...";
          settings.defaultMinimizedText = "Fale com a Adium";
          
          // Domínio para persistência
          settings.storageDomain = window.location.hostname;
          
          // Tamanho do widget
          settings.widgetWidth = "320px";
          settings.widgetHeight = "500px";
          
          // Inicializar
          embeddedservice_bootstrap.init(
            config.orgId,
            config.componentName,
            config.deploymentUrl,
            { scrt2URL: config.scrtUrl }
          );
          
          // Adicionar listener para quando estiver pronto
          if (embeddedservice_bootstrap.utilAPI) {
            embeddedservice_bootstrap.utilAPI.addEventHandler('afterInit', () => setLoading(false));
          }
        } catch (err) {
          setLoading(false);
          alert('Erro ao inicializar o chat. Recarregue a página e tente novamente.');
        }
      };
      
      // Inicia o chat quando o botão é clicado
      const start = () => {
        if (state.loading) return;
        setLoading(true);
        
        // Verifica se a API está disponível
        if (isChatAPIReady()) {
          launchChat();
        } else if (state.retries < config.maxRetries) {
          state.retries++;
          
          // Carrega o script se for a primeira tentativa
          if (state.retries === 1 && !document.getElementById('bootstrap-script')) {
            loadScript();
          }
          
          // Tentar novamente
          setTimeout(start, config.retryDelay);
        } else {
          // Resetar e recarregar
          state.retries = 0;
          setLoading(false);
          loadScript();
          alert('O serviço de chat não está respondendo. Recarregando componentes...');
        }
      };
      
      // Verifica se a API está pronta
      const isChatAPIReady = () => {
        return typeof embeddedservice_bootstrap !== 'undefined' && 
               embeddedservice_bootstrap.utilAPI && 
               typeof embeddedservice_bootstrap.utilAPI.launchChat === 'function';
      };
      
      // Abre o chat
      const launchChat = () => {
        embeddedservice_bootstrap.utilAPI.launchChat()
          .then(() => setLoading(false))
          .catch(() => {
            setLoading(false);
            alert('Não foi possível iniciar o chat. Tente novamente mais tarde.');
          });
      };
      
      // Inicializa quando a página carrega
      window.addEventListener('load', init);
      
      // API pública
      return {
        start,
        loadScript
      };
    })();
  </script>
</body>
</html>
