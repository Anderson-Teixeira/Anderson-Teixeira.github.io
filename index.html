<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Adium</title>
    <style>
        .embeddedServiceHelpButton { display: none !important; }
        
        .botao-chat-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-balloon {
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            font-size: 14px;
            margin-right: 10px;
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.3s;
        }
        
        .chat-balloon::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 10px solid #fff;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }
        
        .botao-chat {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to right, #ff0000, #e60000);
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(255,0,0,0.2);
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .botao-chat:hover {
            background: linear-gradient(to right, #e60000, #cc0000);
            box-shadow: 0 4px 15px rgba(255,0,0,0.3);
            transform: scale(1.1);
        }
        
        .botao-chat:disabled {
            background: #ffcccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .chat-img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            margin: auto;
            display: block;
        }
        
        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s infinite;
        }
        
        .botao-chat.loading .loading-indicator { display: block; }
        .botao-chat.loading .chat-img { opacity: 0.5; }
        .hidden { display: none !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="botao-chat-container">
        <div id="chatBalloon" class="chat-balloon">Como posso ajudar?</div>
        <button id="botaoChat" class="botao-chat" onclick="iniciarChat()">
            <div class="loading-indicator"></div>
            <img src="images/Adium Logo vermelho.png" alt="Logo Adium" class="chat-img"/>
        </button>
    </div>

    <script>
        let tentativas = 0, carregando = false;
        const maxTentativas = 5, intervalo = 2000;
        const botao = document.getElementById('botaoChat');
        const balao = document.getElementById('chatBalloon');
        
        function toggleCarregando(estado) {
            carregando = estado;
            if (estado) {
                botao.classList.add('loading');
                botao.disabled = true;
                balao.classList.add('hidden');
            } else {
                botao.classList.remove('loading');
                botao.disabled = false;
            }
        }
        
        function iniciarChat() {
            if (carregando) return;
            toggleCarregando(true);
            
            if (typeof embeddedservice_bootstrap !== 'undefined' && 
                embeddedservice_bootstrap.utilAPI && 
                typeof embeddedservice_bootstrap.utilAPI.launchChat === 'function') {
                
                embeddedservice_bootstrap.utilAPI.launchChat()
                    .then(() => toggleCarregando(false))
                    .catch(() => {
                        toggleCarregando(false);
                        alert('Não foi possível iniciar o chat. Tente novamente mais tarde.');
                    });
            } else if (tentativas < maxTentativas) {
                tentativas++;
                if (tentativas === 1 && !document.getElementById('bootstrap-script')) {
                    carregarScript();
                }
                setTimeout(iniciarChat, intervalo);
            } else {
                tentativas = 0;
                toggleCarregando(false);
                document.getElementById('bootstrap-script')?.remove();
                carregarScript();
                alert('O serviço de chat não está respondendo. Recarregando componentes...');
            }
        }
        
        function carregarScript() {
            document.getElementById('bootstrap-script')?.remove();
            
            const script = document.createElement('script');
            script.id = 'bootstrap-script';
            script.src = 'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405/assets/js/bootstrap.min.js';
            script.onload = () => setTimeout(configurarChat, 1500);
            script.onerror = () => {
                toggleCarregando(false);
                alert('Não foi possível carregar o serviço de chat. Verifique sua conexão.');
            };
            
            document.head.appendChild(script);
        }
        
        function configurarChat() {
            try {
                if (typeof embeddedservice_bootstrap === 'undefined') {
                    setTimeout(configurarChat, 2000);
                    return;
                }
                
                const settings = embeddedservice_bootstrap.settings;
                
                // Configurações básicas
                settings.language = 'pt_BR';
                settings.displayHelpButton = false;
                settings.chatButtonPosition = "-30px,-200px";
                
                // Avatares e visuais
                settings.avatarImgURL = "images/Adium Logo vermelho.png";
                settings.chatbotAvatarImgURL = "images/Adium Logo vermelho.png";
                settings.smallCompanyLogoImgURL = "images/Adium Logo vermelho.png";
                settings.storageDomain = window.location.hostname;
                settings.loadingText = "Conectando...";
                settings.defaultMinimizedText = "Fale com a Adium";
                
                // Dimensões
                settings.widgetWidth = "320px";
                settings.widgetHeight = "500px";
                
                // Inicialização
                embeddedservice_bootstrap.init(
                    '00DVA000001eH3B',
                    'ChatAdium_GitHubPages',
                    'https://adiumbr--devchatbot.sandbox.my.site.com/ESWChatAdiumGitHubPages1740412245405',
                    {
                        scrt2URL: 'https://adiumbr--devchatbot.sandbox.my.salesforce-scrt.com'
                    }
                );
                
                if (embeddedservice_bootstrap.utilAPI) {
                    embeddedservice_bootstrap.utilAPI.addEventHandler('afterInit', () => toggleCarregando(false));
                }
            } catch (err) {
                toggleCarregando(false);
                alert('Erro ao inicializar o chat. Recarregue a página e tente novamente.');
            }
        }
        
        // Eventos para o balão
        window.addEventListener('load', () => {
            setTimeout(carregarScript, 1000);
            
            botao.addEventListener('mouseenter', () => {
                if (!carregando) balao.classList.remove('hidden');
            });
            
            botao.addEventListener('mouseleave', () => {
                setTimeout(() => balao.classList.add('hidden'), 2000);
            });
            
            setTimeout(() => balao.classList.add('hidden'), 5000);
        });
    </script>
</body>
</html>
